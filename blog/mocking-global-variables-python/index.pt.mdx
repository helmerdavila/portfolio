---
title: 'Fazer mocks de vari√°veis globais em testes Python'
description: Estava tentando testar algumas vari√°veis globais com Python, especialmente para um script que cont√©m vari√°veis globais
date: 2022-05-13
published: true
image: ../../src/images/blog/python-global-envs.jpg
tags: ['python', 'mocking', 'pytest']
---

# Fazer mocks de vari√°veis globais em testes Python

Estava tentando testar algumas vari√°veis globais com Python, especialmente para um script que cont√©m vari√°veis globais. E depois de tentar e falhar, acho que posso mostrar a vers√£o mais simples para faz√™-lo.

## üèÉ A solu√ß√£o r√°pida

```python
# demo_file.py
ENVS = { 'real_value': True, 'another_real_value': False }

# test_your_demo_file.py
mocker.patch("demo_file.ENVS", new={'MOCKED_NONE': None, 'MOCKED_EMPTY': ''})
```

Depois disso, em seu arquivo `demo_file`, a vari√°vel ENVS seria mocks.

## ‚úèÔ∏è Solu√ß√£o com descri√ß√£o

### Requisitos

Para simplicidade do trabalho. Eu recomendo a seguinte biblioteca: [https://pypi.org/project/pytest-mock/](https://pypi.org/project/pytest-mock/)

### Que eu estava tentando fazer?

Primeiro, vamos supor que voc√™ tenha um arquivo chamado `demo_file.py` com o seguinte conte√∫do (e onde a vari√°vel global est√° localizada).

```python
# demo_file.py
import os

ENVS = { 'real_value': os.environ('REAL_VALUE'), 'another_real_value': os.environ('ANOTHER_REAL_VALUE') }

def simple_method():
		print(ENVS)
		return 0
```

Se voc√™ tentar executar `simple_method`, ele imprimir√° o dicion√°rio com `real_value` e `another_real_value` l√°.

Agora temos o seguinte arquivo de teste.

Sei que o teste parece simples, mas est√° garantindo que pelo menos est√° retornando um valor zero ap√≥s imprimir os valores do ENV.

## üëæ Fazer mock da vari√°vel

Mas como voc√™ v√™, estamos chamando as vari√°veis de ambiente no computador atual e, se voc√™ escrever seus testes esperando t√™-los em seu servidor CI/CD, os testes come√ßar√£o a falhar. Como podemos evitar isso e dizer a nosso servidor de teste (ou pipeline de teste) que queremos valores fixos espec√≠ficos?

Se voc√™ instalou o pacote mencionado acima, na se√ß√£o de requisitos, √© muito f√°cil come√ßar a fazer mocks de valores. Ent√£o, s√≥ precisamos adicionar uma √∫nica linha.

```python
# test_my_envs.py
from demo_file import simple_method

@mocker.patch("demo_file.ENVS", new={'MOCKED_REAL_VALUE': None, 'MOCKED_ANOTHER_REAL_VALUE': ''})
def test_if_simple_method_is_working():
		assert simple_method() == 0
```

E seus testes n√£o executar√£o a vari√°vel ENVS real e, portanto, n√£o chamar√£o os `os.environ`.
