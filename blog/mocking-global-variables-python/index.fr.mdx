---
title: 'Faire un mock pour une variable globale dans les tests de Python'
description: J‚Äôai essay√© de tester quelques variables globales dans Python, sp√©cialement pour un script, qui contient des variables globales. Et apr√®s avoir essay√© et essay√© (et √©chouer), je pense que je peux te comment le faire.
date: 2022-05-13
published: true
image: ../../src/images/blog/python-global-envs.jpg
tags: ['python', 'mocking', 'pytest']
---

# Faire un mock pour une variable globale dans les tests de Python

J‚Äôai essay√© de tester quelques variables globales dans Python, sp√©cialement pour un script, qui contient des variables globales. Et apr√®s avoir essay√© et essay√© (et √©chouer), je pense que je peux te comment le faire.

## üèÉ La solution la plus rapide

```python
# fichier_demo.py
ENVS = { 'vraie_valeur': True, 'autre_vraie_valeur': False }

# test_fichier_demo.py
mocker.patch("fichier_demo.ENVS", new={'MOCKED_NONE': None, 'MOCKED_VIDE': ''})
```

Ensuite, dans ton `fichier_demo` , la variable ENVS sera comme _mocked._

## ‚úèÔ∏è La solution avec des descriptions

### Conditions

Pour faciliter le travail, je vais recommander l‚Äôoutil suivant: [https://pypi.org/project/pytest-mock/](https://pypi.org/project/pytest-mock/)

### Qu‚Äôest-ce que je voulais faire?

Tout d‚Äôabord, nous avons un fichier appel√© `fichier_demo.py` avec le contenu suivant (et o√π est la variable globale).

```python
# fichier_demo.py
import os

ENVS = { 'vraie_valeur': os.environ('VRAIE_VALEUR'), 'autre_vraie_valeur': os.environ('VRAIE_VALEUR') }

def fonction_simple():
		print(ENVS)
		return 0
```

Si tu essayes d‚Äô√©xecuter `fonction_simple` , elle montrera le dictionnaire avec `vraie_valeur`et `autre_vraie_valeur` l√†.

Maintenant, nous avons le fichier suivant de test

```python
# tester_mes_envs.py
from fichier_demo import fonction_simple

def tester_si_fonction_simple_fonctionne():
		assert fonction_simple() == 0
```

Voyons, je sais que le test semble simple, mais il s‚Äôassure de retourner une valeur z√©ro apr√®s montrer les valeurs ENVs.

## üëæ √âcrasement et simulation (se moquer) des variables

Comme tu peux le voire, on appelle les variables d‚Äôenvironnement qui vient de l‚Äôordinateur qu‚Äôon utilise, et si tu √©crire tes tests, on esp√®re les avoir dans le serveur CI/CD, ensuite les tests commenceront √† √©chouer. Comment pouvons-nous √©viter √ßa et utiliser des valeurs fix√©es dans notre serveur de tests (ou pipeline).

Si tu as install√© l‚Äôoutil mentionn√© ci-dessus, dans la section de Conditions, il est tr√®s facile de commencer de se moquer des valeurs. On a donc juste besoin d‚Äôajouter une seule ligne.

```python
# tester_mes_envs.py
from fichier_demo import fonction_simple

@mocker.patch("fichier_demo.ENVS", new={'VRAIE_VALEUR_MOCKED': None, 'AUTRE_VRAIE_VALEUR_MOCKED': ''})
def tester_si_fonction_simple_fonctionne():
		assert fonction_simple() == 0
```

Et tes tests n‚Äôex√©cuteront pas la variable `ENV` vraie, et par cons√©quent, ils n‚Äôappelleront pas `os.environ`.
