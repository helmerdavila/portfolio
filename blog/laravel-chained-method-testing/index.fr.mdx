---
title: 'Laravel Facades et Mockery: faire de tests sur des mÃ©thodes enchaÃ®nÃ©es'
description: On utilise la puissance de Mockery
date: 2022-09-11
published: true
image: ../../src/images/blog/chains.jpg
---

# Laravel Facades et Mockery: faire de tests sur des mÃ©thodes enchaÃ®nÃ©es

## ğŸ¤”Â Comment c'est arrivÃ©?â€™

Jâ€™ai essayÃ© de tester Laravel avec PHPUnit. Et jâ€™ai besoin dâ€™Ã©xecuter les Facades de Laravel. SpÃ©cialement, les mÃ©thodes enchaÃ®nÃ©es.

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class ChainController extends Controller
{
    public function index(Request $request)
    {
        Storage::disk('local')->put('/images/content', $request->file('demo'));

        return response()->json(['success' => true]);
    }
}
```

AprÃ¨s Ã§a, mes tests ont Ã©chouÃ© car je nâ€™ai peux pas exÃ©cuter `put` sur `null` . Cela signifiait que `disk` retourne `null`, complÃ¨tement faux.

## ğŸ”¨Â La solution

AprÃ¨s que jâ€™en ai recherchÃ©. Jâ€™ai trouvÃ© la solution dans la documentation de Mockery. Il est utilisÃ© par Laravel pour faire des mocks. La prochaine ligne de code retournera `null` par dÃ©faut et les _assertions_ vont Ã©chouer.

```php
<?php

Storage::disk('s3')->delete('/images/content/demo.png');
```

Alors, la solution vient depuis une mÃ©thode simple de Mockery appelÃ© `andReturnSelf` . Câ€™est dÃ©pend de lâ€™implÃ©mentation de la classe, mais les plusieurs mÃ©thodes enchaÃ®nÃ©es retourneront la mÃªme classe oÃ¹ ils sont crÃ©Ã©s. De mÃªme, tu pourrais utiliser `andReturn` et Ã©crire lâ€™objet, la chaÃ®ne ou la structure de donnes que les Mocks pourraient retourner.

Dans ce cas, jâ€™ai besoin de `andReturnSelf`. On verra comment le rÃ©sultat final fonctionne. Pour le tester, mon `ChainController` est enchaÃ®neÃ© Ã  la route `POST /chain` .

```php
<?php

namespace Tests\Feature;

use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;
use Tests\TestCase;

class ChainControllerTest extends TestCase
{
    public function test_using_facades()
    {
        Storage::fake('local');

        Storage::shouldReceive('disk')->once()->with('local')->andReturnSelf();
        Storage::shouldReceive('put')->once()->withSomeOfArgs('/images/content');

        $response = $this->post('/chain', ['demo' => UploadedFile::fake()->image('hello.jpeg')]);
        $response->assertStatus(200);
    }
}
```

## ğŸ”—Â Des liens

Tu pourras voir dâ€™exemple, [click ici](https://github.com/helmerdavila/blog-tutorials-laravel/blob/1.0.1/tests/Feature/ChainControllerTest.php).
