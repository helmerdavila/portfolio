---
title: 'Laravel Facades y Mockery: Creando tests de m√©todos encadenados'
description: Usando el poder de Mockery
date: 2022-09-11
published: true
image: ../../src/images/blog/chains.jpg
---

# Laravel Facades y Mockery: Creando tests de m√©todos encadenados

## ü§î ¬øC√≥mo sucedi√≥?

Estaba intentando probar Laravel con PHPUnit. Y necesitaba probar los Facades de Laravel, y sobretodo, era un m√©todo encadenado.

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class ChainController extends Controller
{
    public function index(Request $request)
    {
        Storage::disk('local')->put('/imagenes/contenido', $request->file('demo'));

        return response()->json(['exito' => true]);
    }
}
```

Despu√©s de esto, mis tests estaban fallando, debido a que no pod√≠a ejecutar `put` en `null`. Eso significaba, por alg√∫n motivo, que `disk` estaba retornando `null`, lo cual no era verdad.

## üî®¬†Soluci√≥n

Despu√©s de una b√∫squeda. Encontr√© en la documentaci√≥n de Mockery, usado por Laravel para hacer los mocks. En la siguiente l√≠nea si no especificas el retorno, devolver√° `null` por defecto. Y causar√° que los _assertions_ fallen.

```php
<?php

Storage::disk('s3')->delete('/imagenes/contenido/demo.png');
```

La soluci√≥n para esto viene desde un simple m√©todo de Mockery `andReturnSelf` . Nota que esto depende de la implementaci√≥n de la clase, pero la mayor√≠a de m√©todos encadenados retornar√°n la clase donde fueron implementados. Del mismo modo, puedes usar `andReturn` y escribir el objeto, cadena, arreglo o estructura de datos que el Mock retornar√°.

Para este caso espec√≠fico, necesitaba `andReturnSelf` . Veamos como el resultado final funciona. Para probarlo, mi `ChainController` est√° conectado a la ruta `POST /chain` .

```php
<?php

namespace Tests\Feature;

use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;
use Tests\TestCase;

class ChainControllerTest extends TestCase
{
    public function test_using_facades()
    {
        Storage::fake('local');

        Storage::shouldReceive('disk')->once()->with('local')->andReturnSelf();
        Storage::shouldReceive('put')->once()->withSomeOfArgs('/imagenes/contenido');

        $response = $this->post('/chain', ['demo' => UploadedFile::fake()->image('hello.jpeg')]);
        $response->assertStatus(200);
    }
}
```

## üîó¬†Enlaces

Puedes ver un ejemplo funcionando, [click aqu√≠](https://github.com/helmerdavila/blog-tutorials-laravel/blob/1.0.1/tests/Feature/ChainControllerTest.php).
